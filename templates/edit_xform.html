{% extends 'base.html' %}
{% block header %}
<div>
<h1>
	<a href="/">Home</a> &raquo;
	{{xform.id_string}} <em>r{{xform.latest_version.version_number}}</em>
</h1>
</div>
{% endblock %}
{% block content %}

<div id="sections">
	<h3>Active Sections</h3>
	{% if base_sections_empty %}
	<h5>No sections have been marked as active.</h5>
	{% else %}
	<h5>These are the main sections that will be included in this version of the survey.</h5>
	<ol class="form-section-list">
		{% for section in base_sections %}
		<li class="section-{{section.slug}}" data-section-slug="{{section.slug}}">
			<p>
				{{section.slug}}
			</p>
			<p class="status" style="display:none"></p>
			<ul class="sub-sections">
				{% for ss in section.sub_sections %}
				<li>
					{{ss}}
				</li>
				{% endfor %}
			</ul>
			<a class="button deactivate" href="/edit/{{xform.id_string}}/section/{{section.slug}}/deactivate" title="Remove Section">&mdash;</a>
			<a class="button move-up" href="/edit/{{xform.id_string}}/section/{{section.slug}}/up" title="Move Up">Move Up</a>
			<a class="button move-down" href="/edit/{{xform.id_string}}/section/{{section.slug}}/down" title="Move Down">Move Down</a>
		</li>
		{% endfor %}
	</ol>
	<div id="actions">
		<p class="survey-status">
			<!-- we should give feedback in this line.
			{{error_message}}
			 -->
		</p>
		<p class="xform-buttons">
			<!--
			<a href="/edit/{{xform.id_string}}/validate/" id="validate">Validate XForm</a>
			<br>
			-->
			<a href="/edit/{{xform.id_string}}/download/" id="download">Convert to XForm</a>
		</p>
	</div>
	{% endif %}
</div>

<div id="available-sections">
	<h3>Available Sections</h3>
	{% if available_sections_empty %}
	<h5>No sections have been added to the portfolio for this XForm.</h5>
	{% else %}
	<h5>These are the sections that you have made available for the survey.</h5>
	<ul>
		{% for section in available_sections %}
		<li data-section-slug="{{section.slug}}">
			<div class="active-bar left-bar lb-a {% if section.is_marked_included %}active{% else %}inactive{% endif %}"></div>
<!--			<div class="included-bar left-bar lb-b"></div> -->
			<p class="title">
				<span class="section-slug">{{section.slug}}</span> <span class="sub-sections">{% for ss in section.sub_sections %}<span class="ss">{{ss}}</span>{% endfor %}</span>
			</p>
			<p class="section-buttons">
				{% if section.is_marked_included %}
				<a href="/edit/{{xform.id_string}}/section/{{section.slug}}/deactivate" class="make-inactive">[ Remove from XForm ]</a>
				{% else %}
				<a href="/edit/{{xform.id_string}}/section/{{section.slug}}/activate" class="make-active">[ Add to XForm ]</a>
				{% endif %}
				<a href="/edit/{{xform.id_string}}/section/{{section.slug}}/delete" class="delete">[ X ]</a>
			</p>
		</li>
		{% endfor %}
	</ul>
	{% endif %}
	<div id="upload-section">
	<form action="." method="post" enctype="multipart/form-data">
		<h4>
			Upload your section:
		</h4>
		<p style="font-style:italic;color:#888">
			The <u>section's id</u> comes from the name of the file.<br>
			<em>Example: location_questions.xls will have the section's id: location_questions</em>
			<br>
			<br>
			If you would like to correct an error in the section, upload the file again with the same name.
		</p>
		<br>
		<p>
			{% csrf_token %}
			<input type="file" name="section_file" >
			<input type="submit" value="Submit">
		</p>
	</form>
	</div>
</div>

{% endblock %}

{% block js %}
<script type="text/javascript" charset="utf-8">
<!--
/*--
function markOrderChanged() {
	//when the order has been changed. it needs to be synced with the server.
	//a button should be displayed to allow this.
}
$('#sections').delegate('a', 'click', function(evt){
	var thisSection = $(this).parents('li').data('section-slug');
	var li = $(this).parents('li')//.remove();
	if($(this).hasClass('move-up')) {
		if(li.prev().length) {
			li.prev().before(li.remove());
			markOrderChanged();
		}
	} else if ($(this).hasClass('move-down')){
		if(li.next().length) {
			li.next().after(li.remove())
			markOrderChanged();
		}
	}
	evt.preventDefault();
})
--*/
$('#validate').click(function(evt){
	$.getJSON('/edit/{{xform.id_string}}/validate').done(function(data){
		console.log(data);
		if(data.section_stats) {
			$.each(data.section_stats, function(sectionSlug, stat){
				var z = $('.section-'+sectionSlug).addClass(stat.status);
				if(stat.message) {
					z.find('p.status').text(stat.message).show();
				}
			});
		}
		if(data.status=="error") {
			$('p.survey-status').text(data.message).show();
		} else if(data.status=="good") {
			$('p.survey-status').hide();
		}
	});
	evt.preventDefault();
});

var debugJson = $("<a />", {'href':'#'}).text("View Compiled JSON").click(function(evt){
	var ta = $('textarea#t');
	if(ta.length===0) {
		ta = $('<textarea />', {'id':'t'}).css({'width':'96%','height':'200px'});
		$('#actions').append(ta);
	}
	$.getJSON("/edit/{{xform.id_string}}/debug_json").done(function(data){
		ta.text(JSON.stringify(data));
	});
	evt.preventDefault();
}).appendTo($('p.xform-buttons'));
/*--
--*/
-->
</script>
{% endblock %}

<script type="text/javascript" charset="utf-8">
/*-- Some day-- might want to use this code
	var uriContent = "data:application/download," + encodeURIComponent($('body').get(0).innerHTML)
	window.open(uriContent, 'newdoc')
	--*/
</script>

