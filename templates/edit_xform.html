{% extends 'base.html' %}
{% block content %}

<h2>
	{{xform.id_string}}
</h2>
<p>
	Version Number {{xform.versions.count}}
</p>
<table id="available-sections">
	<tbody>
		{% for section in available_sections %}
		<tr>
			<td>
				{{section.slug}}
			</td>
		</tr>
		{% endfor %}
	</tbody>
</table>
<div id="sections">
	<ul>
		{% for section in base_sections %}
		<li class="section-{{section.slug}}" data-section-slug="{{section.slug}}">
			<p>
				{{section.slug}}
			</p>
			<p class="status" style="display:none"></p>
			<p class="buttons">
				<a class="move-up" href="#">[Up]</a>
				<br />
				<a class="move-down" href="#">[Down]</a>
			</p>
		</li>
		{% endfor %}
	</ul>
</div>
<fieldset>
	<legend>
		Add or update a section.
	</legend>
	<form action="." method="post" enctype="multipart/form-data">
		<p>
			Add a section in either XLS or JSON.
		</p>
		<p>
			Your file will pull the section id from the name of the file.
			<em>Example: location_questions.xls will have the section id: location_questions</em>
		</p>
		<p>
			{% csrf_token %}
			<input type="file" name="new_section" >
			<input type="submit" value="Submit">
		</p>
	</form>
</fieldset>
<p class="survey-status" style="display:none">
</p>
<p>
	<a href="/edit_xform/{{xform.id_string}}/validate" id="validate">Validate XForm</a>
	<br>
	<a href="/edit_xform/{{xform.id_string}}/download" id="download">Download XForm</a>
</p>
{% endblock %}

{% block js %}
<script type="text/javascript" charset="utf-8">
<!--
function markOrderChanged() {
	//when the order has been changed. it needs to be synced with the server.
	//a button should be displayed to allow this.
}
$('#sections').delegate('a', 'click', function(evt){
	var thisSection = $(this).parents('li').data('section-slug');
	var li = $(this).parents('li')//.remove();
	if($(this).hasClass('move-up')) {
		if(li.prev().length) {
			li.prev().before(li.remove());
			markOrderChanged();
		}
	} else if ($(this).hasClass('move-down')){
		if(li.next().length) {
			li.next().after(li.remove())
			markOrderChanged();
		}
	}
	evt.preventDefault();
})
$('#validate').click(function(evt){
	$.getJSON('/edit_xform/{{xform.id_string}}/validate').done(function(data){
		console.log(data);
		if(data.section_stats) {
			$.each(data.section_stats, function(sectionSlug, stat){
				var z = $('.section-'+sectionSlug).addClass(stat.status);
				if(stat.message) {
					z.find('p.status').text(stat.message).show();
				}
			});
		}
		if(data.status=="error") {
			$('p.survey-status').text(data.message).show();
		} else if(data.status=="good") {
			$('p.survey-status').hide();
		}
	});
	evt.preventDefault();
});
-->
</script>
{% endblock %}

<script type="text/javascript" charset="utf-8">
/*-- Some day-- might want to use this code
	var uriContent = "data:application/download," + encodeURIComponent($('body').get(0).innerHTML)
	window.open(uriContent, 'newdoc')
	--*/
</script>

